# Data Model: 统一使用 Bash 脚本实现跨平台开发

**Feature**: [spec.md](spec.md) | **Date**: 2026年1月18日

## 概述

本文档定义 Bash 脚本的数据模型，包括脚本参数、环境变量、配置文件和状态管理。

## 实体定义

### 1. 脚本参数模型

#### build.sh 参数

| 参数 | 类型 | 必需 | 默认值 | 说明 |
|------|------|------|--------|------|
| --clean | 标志 | 否 | false | 清理构建产物后再构建 |
| --help | 标志 | 否 | false | 显示帮助信息 |

**验证规则**:
- 不支持位置参数
- 未知参数报错并显示帮助

**示例**:
```bash
./build.sh              # 正常构建
./build.sh --clean      # 清理后构建
./build.sh --help       # 显示帮助
```

---

#### run.sh 参数

| 参数 | 类型 | 必需 | 默认值 | 说明 |
|------|------|------|--------|------|
| [config_file] | 位置参数 | 否 | config/pid_temperature.yaml | 配置文件路径 |
| --shell | 标志 | 否 | false | 进入容器 Shell 而非运行应用 |
| --help | 标志 | 否 | false | 显示帮助信息 |

**验证规则**:
- 配置文件必须存在且可读
- --shell 模式忽略配置文件参数
- 最多一个位置参数

**示例**:
```bash
./run.sh                                    # 使用默认配置
./run.sh config/custom.yaml                 # 使用自定义配置
./run.sh --shell                            # 进入容器 Shell
./run.sh --help                             # 显示帮助
```

---

#### test.sh 参数

| 参数 | 类型 | 必需 | 默认值 | 说明 |
|------|------|------|--------|------|
| --lint | 标志 | 否 | false | 仅运行静态分析（flake8, shellcheck） |
| --unit | 标志 | 否 | false | 仅运行单元测试 |
| --help | 标志 | 否 | false | 显示帮助信息 |

**验证规则**:
- 无参数时运行所有测试（lint + unit）
- --lint 和 --unit 可同时指定（等同于无参数）

**示例**:
```bash
./test.sh               # 运行所有测试
./test.sh --lint        # 仅静态分析
./test.sh --unit        # 仅单元测试
./test.sh --help        # 显示帮助
```

---

### 2. 环境变量模型

#### 必需环境变量（由 Docker/系统提供）

| 变量名 | 来源 | 说明 |
|--------|------|------|
| PWD | Shell | 当前工作目录（脚本使用相对路径） |
| HOME | Shell | 用户主目录（Docker 配置可能使用） |
| TERM | Shell | 终端类型（用于颜色输出检测） |

#### 可选环境变量（用户可自定义）

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| DOCKER_BUILDKIT | 1 | 启用 Docker BuildKit（加速构建） |
| COMPOSE_PROJECT_NAME | plcopen | Docker Compose 项目名称 |

**使用方式**:
```bash
# 在项目根目录创建 .env 文件
DOCKER_BUILDKIT=1
COMPOSE_PROJECT_NAME=my-plcopen
```

---

### 3. 配置文件模型

#### 应用配置文件（YAML）

**位置**: `config/*.yaml`
**格式**: YAML
**用途**: 运行时应用配置（PID 参数、日志级别等）

**关系**: run.sh 将配置文件路径传递给容器内的 Python 应用

**验证**:
- 由 Python 应用负责解析和验证
- Bash 脚本仅检查文件是否存在

---

### 4. 状态和依赖关系

#### 脚本执行状态机

```
┌─────────────┐
│  项目克隆    │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ build.sh    │ ──> 生成 Docker 镜像 + 编译产物
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ test.sh     │ ──> 验证构建质量
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ run.sh      │ ──> 运行应用
└─────────────┘
```

#### 依赖关系矩阵

| 脚本 | 依赖的外部工具 | 依赖的项目文件 | 依赖的其他脚本 |
|------|----------------|----------------|----------------|
| build.sh | docker, docker-compose, make | Dockerfile, docker-compose.yml, Makefile | 无 |
| run.sh | docker, docker-compose | docker-compose.yml, config/*.yaml | build.sh（必须先构建） |
| test.sh | docker, docker-compose, pytest | tests/, setup.py | build.sh（必须先构建） |

**依赖检查**:
- 脚本不主动检查工具是否安装（假设环境已准备）
- Docker 命令失败时依赖 `set -e` 自动退出
- 文档中明确说明前置条件

---

### 5. 输出和日志模型

#### 标准输出（stdout）

**格式**: `[级别] 消息内容`
**级别**: INFO, WARN

**示例**:
```
[INFO] Building Docker image...
[INFO] Running tests in container...
[WARN] Container already running, reusing...
```

#### 标准错误（stderr）

**格式**: `[ERROR] 错误描述`

**示例**:
```
[ERROR] Configuration file not found: config/missing.yaml
[ERROR] Docker build failed
```

#### 退出码

| 退出码 | 含义 |
|--------|------|
| 0 | 成功 |
| 1 | 一般错误（构建失败、测试失败、参数错误） |
| 2 | 使用错误（未知参数） |
| 130 | 用户中断（Ctrl+C） |

---

### 6. 文件系统模型

#### 脚本创建/修改的文件

| 路径 | 类型 | 说明 | 清理方式 |
|------|------|------|---------|
| build/ | 目录 | Python 扩展构建产物 | build.sh --clean |
| bin/ | 目录 | C 运行时可执行文件 | build.sh --clean |
| *.log | 文件 | 运行日志（可选） | 手动删除或 .gitignore |

#### 脚本读取的文件

| 路径 | 必需 | 说明 |
|------|------|------|
| Dockerfile | 是 | Docker 镜像定义 |
| docker-compose.yml | 是 | Docker Compose 配置 |
| Makefile | 是 | C 项目构建规则 |
| setup.py | 是 | Python 扩展构建配置 |
| config/*.yaml | 运行时必需 | 应用配置 |
| tests/ | 测试时必需 | 测试用例 |

---

## 数据流图

### build.sh 数据流

```
用户输入 (--clean)
    │
    ▼
┌─────────────────┐
│  参数解析        │
└────────┬────────┘
         │
         ▼
    [ --clean? ]
         │
    是───┴───否
    │         │
    ▼         ▼
┌────────┐  ┌────────┐
│ 清理产物 │  │ 跳过清理 │
└───┬────┘  └───┬────┘
    │           │
    └─────┬─────┘
          │
          ▼
┌──────────────────┐
│ Docker 镜像构建   │ ─> docker-compose build
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 容器内 Make 构建  │ ─> docker exec ... make
└────────┬─────────┘
         │
         ▼
    [ 成功? ]
         │
    是───┴───否
    │         │
    ▼         ▼
┌────────┐  ┌────────┐
│ 退出 0  │  │ 退出 1  │
└────────┘  └────────┘
```

### run.sh 数据流

```
用户输入 (config_file, --shell)
    │
    ▼
┌─────────────────┐
│  参数解析        │
└────────┬────────┘
         │
         ▼
    [ --shell? ]
         │
    是───┴───否
    │         │
    ▼         ▼
┌────────┐  ┌──────────┐
│ Shell   │  │ 检查配置  │
│ 模式    │  │ 文件      │
└───┬────┘  └───┬──────┘
    │           │
    │           ▼
    │      [ 存在? ]
    │           │
    │      是───┴───否
    │      │         │
    │      │         ▼
    │      │    ┌────────┐
    │      │    │ 错误退出│
    │      │    └────────┘
    │      │
    └──────┼────────┐
           │        │
           ▼        ▼
    ┌──────────┐  ┌──────────┐
    │ docker   │  │ docker   │
    │ exec     │  │ exec     │
    │ bash     │  │ python   │
    └────────  ┘  └──────────┘
```

---

## 关键约束

### 数据验证约束

1. **参数验证**:
   - 所有参数必须是预定义的标志或位置参数
   - 未知参数立即报错

2. **文件验证**:
   - 配置文件必须存在且可读
   - 不验证 YAML 语法（由应用负责）

3. **环境验证**:
   - 不主动检查工具（Docker/Make）是否安装
   - 依赖命令失败时的自动退出（set -e）

### 并发和状态约束

1. **并发性**:
   - 不支持并行执行同一脚本的多个实例
   - Docker 容器命名确保单实例运行

2. **状态管理**:
   - 脚本是无状态的（每次执行独立）
   - 依赖 Docker 和文件系统维护构建状态

---

## 扩展性考虑

### 未来可能添加的参数

| 脚本 | 参数 | 用途 |
|------|------|------|
| build.sh | --no-cache | 禁用 Docker 缓存 |
| run.sh | --debug | 启用调试模式（保留容器） |
| test.sh | --coverage | 生成测试覆盖率报告 |

**设计原则**: 仅在用户明确需求时添加，保持简洁优先。
