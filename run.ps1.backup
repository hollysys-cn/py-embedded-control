# PowerShell Run Script
# Run PLCopen Python Runtime on Windows using Docker

param(
    [string]$Config = "config/pid_temperature.yaml",
    [switch]$Debug,
    [switch]$Shell
)

$ErrorActionPreference = "Stop"

function Write-Info {
    param([string]$Message)
    Write-Host "[INFO] $Message" -ForegroundColor Green
}

function Write-Error-Custom {
    param([string]$Message)
    Write-Host "[ERROR] $Message" -ForegroundColor Red
}

# Check if Docker is available
function Test-Docker {
    try {
        $null = docker --version
        return $true
    } catch {
        Write-Error-Custom "Docker is not installed or not running"
        return $false
    }
}

# Main logic
if (-not (Test-Docker)) {
    exit 1
}

if ($Shell) {
    Write-Info "Starting Docker development shell..."

    # 确保容器正在运行
    $containerStatus = docker ps -q -f name=plcopen-dev
    if (-not $containerStatus) {
        Write-Info "Starting development container..."
        docker-compose up -d dev
        Start-Sleep -Seconds 2
    }

    docker exec -it plcopen-dev bash
    exit 0
}

# 确保开发容器正在运行
$containerStatus = docker ps -q -f name=plcopen-dev
if (-not $containerStatus) {
    Write-Info "Starting development container..."
    docker-compose up -d dev
    Start-Sleep -Seconds 2
}

if ($Debug) {
    $Config = "config/pid_temperature_debug.yaml"
    Write-Info "使用调试配置: $Config"
    Write-Info "调试端口: 5678"
    Write-Host ""
    Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan
    Write-Host "  调试模式已启动" -ForegroundColor Green
    Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan
    Write-Host ""
    Write-Info "启动运行时..."

    # 在后台启动运行时（带 debugpy）
    Start-Job -Name "PLCRuntime" -ScriptBlock {
        param($Config)
        $bashCmd = "cd /workspace && ./bin/plcopen_runtime --config $Config"
        docker exec -i plcopen-dev bash -c $bashCmd
    } -ArgumentList $Config | Out-Null

    # 等待 debugpy 服务器启动
    Start-Sleep -Seconds 3

    Write-Host ""
    Write-Info "debugpy 服务器已启动，等待调试器连接..."
    Write-Host ""
    Write-Host "下一步：在 VS Code 中附加调试器" -ForegroundColor Yellow
    Write-Host ""
    Write-Host "  1. 按 F5 或点击'运行和调试'" -ForegroundColor White
    Write-Host "  2. 选择: 'Python: 附加到运行时（本地）'" -ForegroundColor White
    Write-Host "  3. 在 python/examples/pid_temperature.py 中设置断点" -ForegroundColor White
    Write-Host ""
    Write-Host "调试提示：" -ForegroundColor Yellow
    Write-Host "  • F10: 单步跳过" -ForegroundColor Gray
    Write-Host "  • F11: 单步进入" -ForegroundColor Gray
    Write-Host "  • 在'变量'面板查看实时数据" -ForegroundColor Gray
    Write-Host ""
    Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan
    Write-Host ""
    Write-Info "查看程序输出: Get-Job -Name PLCRuntime | Receive-Job"
    Write-Info "停止调试: docker exec plcopen-dev pkill -f plcopen_runtime"
    Write-Host ""
    Write-Host "按任意键查看运行时输出..." -ForegroundColor Cyan
    $null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")

    # 显示输出
    Write-Host ""
    Get-Job -Name "PLCRuntime" | Receive-Job

    # 等待任务
    Get-Job -Name "PLCRuntime" | Wait-Job | Out-Null
    Get-Job -Name "PLCRuntime" | Remove-Job -Force
} else {
    Write-Info "Starting runtime: $Config"
    Write-Info "Press Ctrl+C to stop"
    Write-Info "Note: Python output will be shown in real-time"

    # 使用 docker exec 在运行中的容器内执行命令
    # 这样 Ctrl+C 可以正常工作
    $bashCmd = "cd /workspace && ./bin/plcopen_runtime --config $Config"
    docker exec -it plcopen-dev bash -c $bashCmd
}
