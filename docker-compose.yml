services:
  # x86_64 开发环境
  dev:
    build:
      context: .
      dockerfile: Dockerfile
    image: plcopen-runtime-dev:latest
    container_name: plcopen-dev
    platform: linux/amd64
    volumes:
      - .:/workspace
    working_dir: /workspace
    ports:
      - "5678:5678"  # debugpy Python 调试端口
      - "9000:9000"  # gdbserver C/C++ 调试端口（可选）
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
    # 启用特权模式以支持 gdb/valgrind 等调试工具
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp:unconfined
    command: tail -f /dev/null  # 保持容器运行
    networks:
      - plcopen-net

  # ARM64 测试环境
  arm-test:
    build:
      context: .
      dockerfile: Dockerfile
    image: plcopen-runtime-arm64:latest
    container_name: plcopen-arm-test
    platform: linux/arm64
    volumes:
      - .:/workspace
    working_dir: /workspace
    ports:
      - "5679:5678"  # debugpy 调试端口（主机端口 5679）
      - "9001:9000"  # gdbserver 调试端口（主机端口 9001）
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp:unconfined
    command: tail -f /dev/null  # 保持容器运行
    networks:
      - plcopen-net

networks:
  plcopen-net:
    driver: bridge
