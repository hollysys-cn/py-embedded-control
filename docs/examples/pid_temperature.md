# PID 温度控制示例

## 示例说明

本示例演示如何使用 PLCopen Python 运行时环境实现一个简单的温度控制系统。系统使用 PID 控制器调节加热器输出，使模拟温度收敛到设定值。

## 物理模型

### 加热系统

- **加热器**：控制输出 0-100% 对应不同的加热功率
- **散热**：温度越高，自然散热越快（牛顿冷却定律）
- **环境温度**：20°C
- **传感器噪声**：±0.1°C 随机噪声模拟真实传感器

### 数学模型

```
温度变化率 = 加热贡献 - 散热贡献
加热贡献 = 控制输出 × 0.01
散热贡献 = (当前温度 - 环境温度) × 0.05
```

## PID 参数

### 默认配置

- **Kp = 3.0**: 比例系数，较强的比例作用
- **Ki = 0.2**: 积分系数，消除稳态误差
- **Kd = 0.5**: 微分系数，抑制超调
- **output_min = 0**: 最小控制输出
- **output_max = 100**: 最大控制输出

### 参数调整指南

1. **Kp（比例系数）**
   - 增大：响应速度加快，但可能产生振荡
   - 减小：响应速度变慢，稳定性提高
   - 推荐范围：2.0 - 5.0

2. **Ki（积分系数）**
   - 增大：消除稳态误差，但可能产生超调
   - 减小：减少超调，但可能存在稳态误差
   - 推荐范围：0.1 - 0.5

3. **Kd（微分系数）**
   - 增大：抑制超调和振荡
   - 减小：对快速变化响应减弱
   - 推荐范围：0.2 - 1.0

## 运行示例

### 方式 1：本地测试模式

直接运行 Python 脚本（不使用运行时）：

```bash
python3 python/examples/pid_temperature.py
```

输出示例：

```
============================================================
PID 温度控制本地测试
============================================================
PID 温度控制初始化完成
  目标温度: 25.0°C
  初始温度: 20.0°C
  PID 参数: Kp=3.0, Ki=0.2, Kd=0.5
------------------------------------------------------------
周期   10 | 温度: 21.07°C | 误差:  3.930°C | 控制输出:  12.3%
周期   20 | 温度: 21.52°C | 误差:  3.476°C | 控制输出:  10.4%
周期   30 | 温度: 21.72°C | 误差:  3.280°C | 控制输出:   9.6%
...
```

### 方式 2：使用运行时环境

使用 PLCopen 运行时执行（实时调度）：

```bash
bin/plcopen_runtime --config config/pid_temperature.yaml
```

### 方式 3：Docker 容器

```bash
# 构建镜像
docker build -t plcopen-runtime .

# 运行示例
docker run --rm plcopen-runtime
```

## 预期结果

- **初始状态**：温度为 20°C
- **设定值**：25°C
- **收敛过程**：
  - 前 10 个周期：快速上升
  - 10-50 个周期：逐渐收敛
  - 50+ 个周期：稳定在设定值附近（±0.2°C）
- **稳态误差**：由于积分作用，最终误差趋近于 0

## 故障排查

### 温度振荡

**现象**：温度围绕设定值大幅波动

**原因**：
- Kp 过大
- Kd 过小

**解决方案**：
- 减小 Kp（例如从 3.0 降到 2.0）
- 增大 Kd（例如从 0.5 升到 1.0）

### 响应过慢

**现象**：温度长时间无法达到设定值

**原因**：
- Kp 过小
- Ki 过小

**解决方案**：
- 增大 Kp（例如从 3.0 升到 4.0）
- 增大 Ki（例如从 0.2 升到 0.3）

### 存在稳态误差

**现象**：温度稳定后与设定值存在偏差

**原因**：
- Ki 为 0 或过小

**解决方案**：
- 增大 Ki（例如从 0.1 升到 0.3）

## 扩展练习

1. **修改设定值**：在 `pid_temperature.py` 中修改 `setpoint` 变量，观察控制效果

2. **调整物理模型**：修改加热系数和散热系数，模拟不同的系统特性

3. **添加扰动**：在运行过程中动态改变环境温度，测试 PID 的抗扰能力

4. **实现串级控制**：添加温度变化率控制，实现更精确的温度调节

5. **数据记录**：添加数据记录功能，绘制温度曲线分析控制性能

## 相关文件

- 示例脚本：`python/examples/pid_temperature.py`
- 配置文件：`config/pid_temperature.yaml`
- PID 实现：`src/function_blocks/fb_pid.c`
- Python 绑定：`src/python_bindings/py_pid.c`
- 高级封装：`python/plcopen/blocks.py`
